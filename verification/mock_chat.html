<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Verification</title>
    <!-- Mock Vue and dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/marked/marked.min.js"></script>
    <script src="https://unpkg.com/dompurify/dist/purify.min.js"></script>

    <!-- Local CSS -->
    <link rel="stylesheet" href="../ai_integration/public/css/ai-chat.css">

    <style>
        body { margin: 0; padding: 20px; background: #f0f4f8; font-family: sans-serif; }
        #page-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            height: 800px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .page-head { margin-bottom: 20px; }

        /* Font Awesome Mock */
        .fa { font-family: monospace; }
    </style>
</head>
<body>

<div id="page-container">
    <div class="page-head">
        <h2>AI Chat Page Mock</h2>
    </div>
    <div id="chat-wrapper" style="height: 100%; position:relative;"></div>
</div>

<script>
    // Mock Frappe Object
    window.frappe = {
        pages: { 'ai-chat': {} },
        ui: {
            make_app_page: function(opts) {
                const mainDiv = document.createElement('div');
                mainDiv.className = 'layout-main-section';
                document.getElementById('chat-wrapper').appendChild(mainDiv);

                return {
                    main: {
                        html: function(content) {
                            mainDiv.innerHTML = content;
                        }
                    }
                };
            }
        },
        require: function(path, callback) {
            // Mock require - dependencies already loaded via CDN
            if (callback) callback();
        },
        call: async function(opts) {
            console.log("Mock Call:", opts);

            if (opts.method === 'ai_integration.api.chat.get_user_sessions') {
                return {
                    message: [
                        { name: 'SESSION-1', title: 'Invoice Query', creation: '2023-10-27 10:00:00' },
                        { name: 'SESSION-2', title: 'Customer Analysis', creation: '2023-10-26 15:30:00' }
                    ]
                };
            }

            if (opts.method === 'ai_integration.api.chat.get_session_history') {
                return {
                    message: [
                        { role: 'user', content: 'Show me invoices' },
                        { role: 'ai', content: 'Here are the invoices...' }
                    ]
                };
            }

            if (opts.method === 'ai_integration.api.chat.send_message') {
                 return {
                    message: {
                        response: "I am a mock AI response.",
                        session_id: opts.args.session_id || 'SESSION-NEW-' + Date.now()
                    }
                 };
            }

            return { message: {} };
        },
        msgprint: function(msg) { alert(msg); }
    };

    // Load local JS logic manually
    // We need to slightly adjust the `frappe.pages['ai-chat'].on_page_load` execution
    // because we don't have the full frappe event system.
</script>

<!-- Injected script content from ai_chat.js to avoid path issues and wrap execution -->
<script>
    // Reading content of ai_chat.js and executing it
    // (In a real scenario I would <script src="..."> but here I want to ensure it runs immediately)
</script>


<script>
frappe.pages['ai-chat'].on_page_load = function(wrapper) {
	var page = frappe.ui.make_app_page({
		parent: wrapper,
		title: 'AI Chat',
		single_column: true
	});

    // We will inject the Vue App container
    page.main.html(`
        <div id="ai-chat-app" class="ai-chat-container">
            <!-- Sidebar for Sessions -->
            <div class="chat-sidebar" :class="{ 'open': sidebarOpen }">
                <div class="sidebar-header">
                    <button class="new-chat-btn" @click="createNewChat">
                        <span class="icon">+</span> New Chat
                    </button>
                    <button class="toggle-sidebar" @click="sidebarOpen = !sidebarOpen">
                        &times;
                    </button>
                </div>
                <div class="session-list">
                    <div v-for="session in sessions"
                         :key="session.name"
                         :class="['session-item', { active: currentSessionId === session.name }]"
                         @click="loadSession(session.name)">
                        <div class="session-title">{{ session.title }}</div>
                        <div class="session-date">{{ formatDate(session.creation) }}</div>
                    </div>
                    <div v-if="sessions.length === 0" class="no-sessions">
                        No history yet.
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-main">
                <div class="mobile-header">
                     <button class="menu-btn" @click="sidebarOpen = !sidebarOpen">
                        &#9776; History
                    </button>
                </div>
                <div class="chat-glass">
                    <div class="chat-header">
                        <h3>{{ currentSessionTitle || 'Gemini Assistant' }}</h3>
                    </div>
                    <div class="chat-messages" ref="messagesContainer">
                        <div v-if="messages.length === 0" class="empty-state">
                            <p>How can I help you today?</p>
                        </div>
                        <div v-for="(msg, index) in messages" :key="index" :class="['message-row', msg.role]">
                            <div class="message-bubble">
                                <div class="message-content" v-html="parseMarkdown(msg.content)"></div>
                            </div>
                        </div>
                        <div v-if="loading" class="message-row ai">
                            <div class="message-bubble loading">
                                <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" v-model="userInput" @keyup.enter="sendMessage" placeholder="Ask about your ERP data..." :disabled="loading" />
                        <button @click="sendMessage" :disabled="loading || !userInput">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `);

    // Add styles dynamically
    frappe.require('/assets/ai_integration/css/ai-chat.css');

    // Initialize Vue
    if (typeof Vue === 'undefined') {
         frappe.require(['/assets/ai_integration/js/vue.global.prod.js', '/assets/ai_integration/js/marked.umd.js', '/assets/ai_integration/js/purify.min.js'], () => {
             initVue(wrapper);
         });
    } else {
         frappe.require(['/assets/ai_integration/js/marked.umd.js', '/assets/ai_integration/js/purify.min.js'], () => {
             initVue(wrapper);
         });
    }
}

function initVue(wrapper) {
    const { createApp, ref, nextTick, onMounted, watch } = Vue;

    const app = createApp({
        setup() {
            const sessions = ref([]);
            const messages = ref([]);
            const userInput = ref('');
            const loading = ref(false);
            const currentSessionId = ref(null);
            const currentSessionTitle = ref('');
            const sidebarOpen = ref(false);
            const messagesContainer = ref(null);

            const fetchSessions = async () => {
                try {
                    const r = await frappe.call({
                        method: 'ai_integration.api.chat.get_user_sessions'
                    });
                    if (r.message) {
                        sessions.value = r.message;
                    }
                } catch (e) {
                    console.error("Failed to fetch sessions", e);
                }
            };

            const loadSession = async (sessionId) => {
                if (currentSessionId.value === sessionId) return;

                loading.value = true;
                currentSessionId.value = sessionId;

                // Update Title
                const session = sessions.value.find(s => s.name === sessionId);
                if (session) currentSessionTitle.value = session.title;

                // Update URL
                updateRoute(sessionId);

                // Close sidebar on mobile
                if (window.innerWidth < 768) {
                    sidebarOpen.value = false;
                }

                try {
                    const r = await frappe.call({
                        method: 'ai_integration.api.chat.get_session_history',
                        args: { session_id: sessionId }
                    });
                    if (r.message && !r.message.error) {
                        messages.value = r.message;
                        scrollToBottom();
                    } else {
                        frappe.msgprint(r.message.error || "Error loading session");
                    }
                } catch (e) {
                    console.error(e);
                    frappe.msgprint("Connection Error");
                } finally {
                    loading.value = false;
                }
            };

            const createNewChat = () => {
                currentSessionId.value = null;
                currentSessionTitle.value = '';
                messages.value = [];
                updateRoute(null);
                if (window.innerWidth < 768) {
                    sidebarOpen.value = false;
                }
            };

            const updateRoute = (sessionId) => {
                const route = ['ai-chat'];
                // We use query param for session to avoid complex routing issues
                if (sessionId) {
                     const newUrl = new URL(window.location);
                     newUrl.searchParams.set('session', sessionId);
                     window.history.pushState({}, '', newUrl);
                } else {
                     const newUrl = new URL(window.location);
                     newUrl.searchParams.delete('session');
                     window.history.pushState({}, '', newUrl);
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            };

            const processDocumentLinks = (html) => {
                const docTypePattern = /\b([A-Z][A-Za-z]+(?:\s[A-Z][A-Za-z]+)*)\s+([A-Z0-9]+-[A-Z0-9-]+)\b/g;
                return html.replace(docTypePattern, (match, p1, p2) => {
                    const doctypeSlug = p1.toLowerCase().replace(/\s+/g, '-');
                    const url = `/app/${doctypeSlug}/${p2}`;
                    return `<a href="${url}" class="doc-link" target="_blank" title="Open ${p1}">${match}</a>`;
                });
            };

            const parseMarkdown = (content) => {
                if (typeof marked !== 'undefined' && marked.parse) {
                    let rawHtml = marked.parse(content);
                    if (typeof DOMPurify !== 'undefined') {
                        const cleanHtml = DOMPurify.sanitize(rawHtml, { ADD_ATTR: ['target', 'class'] });
                         return processDocumentLinks(cleanHtml);
                    }
                    return processDocumentLinks(rawHtml);
                }
                return content;
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    const el = document.querySelector('.chat-messages');
                    if (el) el.scrollTop = el.scrollHeight;
                });
            };

            const sendMessage = async () => {
                if (!userInput.value.trim()) return;

                const text = userInput.value;
                messages.value.push({ role: 'user', content: text });
                userInput.value = '';
                loading.value = true;
                scrollToBottom();

                try {
                    const r = await frappe.call({
                        method: 'ai_integration.api.chat.send_message',
                        args: {
                            message: text,
                            session_id: currentSessionId.value
                        }
                    });

                    if (r.message && r.message.response) {
                        messages.value.push({ role: 'ai', content: r.message.response });

                        // Handle new session creation
                        if (r.message.session_id && r.message.session_id !== currentSessionId.value) {
                             currentSessionId.value = r.message.session_id;
                             updateRoute(currentSessionId.value);
                             // Refresh sessions list to show the new one
                             fetchSessions();
                             // Fetch title if needed (though we can guess it)
                             currentSessionTitle.value = text.substring(0, 30) + '...';
                        }

                    } else if (r.message && r.message.error) {
                         messages.value.push({ role: 'ai', content: 'Error: ' + r.message.error });
                    } else {
                        messages.value.push({ role: 'ai', content: 'Something went wrong.' });
                    }
                } catch (e) {
                    console.error(e);
                    messages.value.push({ role: 'ai', content: 'Connection error.' });
                } finally {
                    loading.value = false;
                    scrollToBottom();
                }
            };

            onMounted(() => {
                fetchSessions();

                // Check URL for session ID
                const params = new URLSearchParams(window.location.search);
                const sessionId = params.get('session');
                if (sessionId) {
                    loadSession(sessionId);
                }
            });

            return {
                sessions,
                messages,
                userInput,
                sendMessage,
                loading,
                messagesContainer,
                parseMarkdown,
                currentSessionId,
                currentSessionTitle,
                loadSession,
                createNewChat,
                formatDate,
                sidebarOpen
            };
        }
    });

    app.mount('#ai-chat-app');
}


// Trigger load
const wrapper = document.createElement('div');
document.getElementById('chat-wrapper').appendChild(wrapper);

// Call the page load handler defined in ai_chat.js
if (frappe.pages['ai-chat'].on_page_load) {
    frappe.pages['ai-chat'].on_page_load(wrapper);
}
</script>
<script type="module">
    // Dynamically import or just paste the logic?
    // I will read the file in python and create this HTML with the content embedded.
</script>

</body>
</html>
